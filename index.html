<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Inscripción - Escaneo CURP</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    h2 { color: #333; text-align: center; }
    input, select, button { margin: 5px 0; padding: 8px; width: 100%; }
    form { background: white; padding: 20px; border-radius: 8px; max-width: 500px; margin: 20px auto; }
    #reader { width: 100%; margin: auto; display: none; }
    #btn-detener { background: #c0392b; color: white; margin-top: 10px; }
  </style>
</head>
<body>

<h2>Registro de Nuevo Ingreso</h2>

<div style="text-align: center;">
  <button id="btn-escanear"> Escanear CURP</button>
  <button id="btn-detener" style="display: none;"> Detener escaneo</button>
</div>

<div id="reader"></div>

<form id="registroForm">
  <label>Nombre del alumno:</label>
  <input type="text" id="nombre" required>

  <label>CURP:</label>
  <input type="text" id="curp" required>

  <label>Sexo:</label>
  <select id="sexo">
    <option value="Hombre">Hombre</option>
    <option value="Mujer">Mujer</option>
  </select>

  <label>Edad:</label>
  <input type="number" id="edad" required>

  <label>Promedio de primaria:</label>
  <input type="number" step="0.1" id="promedio" required>

  <label>Escuela de procedencia:</label>
  <input type="text" id="escuela" required>

  <label>¿Tiene alguna discapacidad?</label>
  <select id="discapacidad">
    <option value="No">No</option>
    <option value="Sí">Sí</option>
  </select>

  <button type="submit"> Guardar registro</button>
</form>

<script>
  const form = document.getElementById("registroForm");
  const btnEscanear = document.getElementById("btn-escanear");
  const btnDetener = document.getElementById("btn-detener");
  const readerDiv = document.getElementById("reader");
  let qrScanner;

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const datos = {
      nombre: document.getElementById("nombre").value,
      curp: document.getElementById("curp").value,
      sexo: document.getElementById("sexo").value,
      edad: document.getElementById("edad").value,
      promedio: document.getElementById("promedio").value,
      escuela: document.getElementById("escuela").value,
      discapacidad: document.getElementById("discapacidad").value,
      timestamp: new Date().toISOString()
    };
    const registros = JSON.parse(localStorage.getItem("registros")) || [];
    registros.push(datos);
    localStorage.setItem("registros", JSON.stringify(registros));
    alert("¡Registro guardado correctamente!");
    form.reset();
  });

  btnEscanear.addEventListener("click", () => {
    readerDiv.style.display = "block";
    btnDetener.style.display = "inline-block";
    qrScanner = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        let rearCamera = devices.find(device => device.label.toLowerCase().includes("back")) || devices[0];
        if (!rearCamera) alert("No se detectó cámara trasera. Se usará la disponible.");
        qrScanner.start(
          rearCamera.id,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            if (!document.getElementById("curp").value) {
              document.getElementById("curp").value = qrCodeMessage;
              qrScanner.stop().then(() => {
                readerDiv.style.display = "none";
                btnDetener.style.display = "none";
              });
            }
          },
          errorMessage => { /* Errores ignorados por ahora */ }
        );
      } else {
        alert("No se detectaron cámaras en este dispositivo.");
      }
    });
  });

  btnDetener.addEventListener("click", () => {
    if (qrScanner) {
      qrScanner.stop().then(() => {
        readerDiv.style.display = "none";
        btnDetener.style.display = "none";
      });
    }
  });
</script>

</body>
</html>
